<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>BioPred</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="icon" type="image/png" href="img/icon.png">
</head>
<body>
<!--	<img src="img\menu.png" class="menu" onclick="togglemenu()">-->
	<nav id="menu">
		<ul>
			<li><a href="about.html">ABOUT</a></li>
			<li><a href="us.html">THE RESEARCHERS</a></li>
			<li><a href="how.html">HOW IT WORKS</a></li>
		</ul>
		<h1>KBD: BIOPRED</h1>
	</nav>

<!--	<div id="controls">-->
<!--&lt;!&ndash;		<button id="recordButton">RECORD</button>&ndash;&gt;-->
<!--		<button id="uploadButton">UPLOAD FILES</button>-->
<!--	</div>-->

	<!-- inserting these scripts at the end to be able to use all the elements in the DOM -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>

<div id="controls">
	<form id="upload-form">
		<div class="custom-file-input-wrapper">
			<input type="file" id="audio-file" name="audio-file" accept="audio/*" class="custom-file-input">
			<label for="audio-file" class="custom-file-input-label">Choose file</label>
		</div>
		<button id="process-btn" onclick="processAudio()">PROCESS</button>

	</form>
	<p id="file-name-label">AUDIO FILE</p>
	<p id="file-name"></p>
</div>

<div id="result">
	<p id="age-label">Age:</p>
	<p id="sex-label">Sex:</p>
	<p id="weight-label">Weight:</p>
	<p id="height-label">Height:</p>
</div>

<script>
	//audio file
	const fileInput = document.getElementById('audio-file');
	const fileNameDisplay = document.getElementById('file-name');

	fileInput.addEventListener('change', () => {
		const file = fileInput.files[0];
		fileNameDisplay.textContent = file ? file.name : '';
	});
</script>
<script>
	async function processAudio() {
		try {
			// Load the model
			const model = await tf.loadLayersModel('../models/model.json');
			const fileInput = document.getElementById('audio-file');
			const fileNameDisplay = document.getElementById('file-name');
			const processButton = document.getElementById('process-btn');

			fileInput.addEventListener('change', function() {
				fileNameDisplay.textContent = fileInput.files[0].name;
			});

			processButton.addEventListener('click', async function() {
				if (!fileInput.value) {
					alert('Please select a file');
					return;
				}

				processButton.textContent = 'Processing...';
				processButton.disabled = true;

				const file = fileInput.files[0];
				const audioContext = new AudioContext();
				const audioBuffer = await audioContext.decodeAudioData(await file.arrayBuffer());
				const audioTensor = tf.tidy(() => {
					const waveform = tf.tensor(audioBuffer.getChannelData(0));
					const batched = waveform.reshape([1, -1, 1]);
					const normalized = batched.div(32768.0);
					return normalized;
				});

				const prediction = await model.predict(audioTensor);
				const predictionArray = await prediction.array();

				const age = predictionArray[0][0];
				const sex = predictionArray[0][1];
				const weight = predictionArray[0][2];
				const height = predictionArray[0][3];

				const resultDisplay = document.getElementById('result');
				let ageLabel = document.getElementById('age-label');
				let sexLabel = document.getElementById('sex-label');
				let weightLabel = document.getElementById('weight-label');
				let heightLabel = document.getElementById('height-label');

				ageLabel.innerHTML = `Age: ${age.toFixed(2)}`;
				sexLabel.innerHTML = `Sex: ${sex.toFixed(2)}`;
				weightLabel.innerHTML = `Weight: ${weight.toFixed(2)}`;
				heightLabel.innerHTML = `Height: ${height.toFixed(2)}`;

				processButton.textContent = 'PROCESS';
				processButton.disabled = false;
			});
		} catch (error) {
			console.error('Error loading the model:', error);
		}
	}
</script>


</body>
<footer>
	<p>KOBEDELTAPHI Â© 2023</p>
</footer>
</html>